services:
  health-discovery-hd:
    image: registry.averbis.com/health-discovery/health-discovery:6.18.1@sha256:d95b5cc112b7f617d6071af6b05163c1df00476bc4cbc75e8dc44e26d196c2c3
    ports:
      - "9999:8080"
    environment:
      - PLATFORM_PORT=8080
      - PLATFORM_MAX_MEM=${PRODUCT_MAX_MEM:-24g}
      - DATABASE_DRIVER_CLASS=org.mariadb.jdbc.Driver
      - DATABASE_URL=jdbc:mariadb://database:3306/aif?useMysqlMetadata=true
      - DATABASE_USERNAME=aif
      - DATABASE_PASSWORD=getaccess
      - GCM_HOSTNAME=gcm
      - GCM_PORT=8181
      - SOLR_HOSTNAME=solr
      - SOLR_PORT=8983
    depends_on:
      - database
      - solr
      - gcm
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health-discovery"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 1m

  database:
    image: docker.io/library/mariadb:11.0.2@sha256:228396b810760b959bc99fd03d2a5fec0b056ceaef9e525a12e9b3c4b883a3af
    command: --max_allowed_packet=1g --innodb_buffer_pool_size=512m --innodb_log_buffer_size=256m --innodb_log_file_size=256m
    environment:
      - MYSQL_ROOT_PASSWORD=getaccess
      - MYSQL_DATABASE=aif
      - MYSQL_USER=aif
      - MYSQL_PASSWORD=getaccess

  solr:
    image: registry.averbis.com/solr/solr:7.6.0@sha256:cc0658c36605248aa059c401b4303f9059280ed3fb248ab6a6d9513b4ca21d6e
    environment:
      - SOLR_MAX_MEM=512m
      - TEXTANALYSIS_URL=http://${PLATFORM_HOSTNAME:-health-discovery-hd}:${PLATFORM_PORT:-8080}/health-discovery/rest
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/terms/admin/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

  gcm:
    image: registry.averbis.com/gcm/gcm:7.6.0@sha256:5adbe4a364a9c7c1deaa2e2f34959367fbeed3c2ccc1d4d6f60d86e39344e06b
    environment:
      - JAVA_MAX_MEM=2g
      - PLATFORM_HOSTNAME=${PLATFORM_HOSTNAME:-health-discovery-hd}
      - PLATFORM_PORT=${PLATFORM_PORT:-8080}
      - PLATFORM_URL_NAME=health-discovery
      - GCM_HOSTNAME=gcm
      - GCM_PORT=8181
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:8181/connector-manager/testConnectivity",
        ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s

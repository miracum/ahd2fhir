services:
  health-discovery-hd:
    image: registry.averbis.com/health-discovery/health-discovery:7.4.0@sha256:31b2f3cf0b4897ee25361f2da24fba0bb21a57a26b2c76b66af1baddebb14b2f
    ports:
      - "${PRODUCT_BIND_ADDR:-0.0.0.0}:${PRODUCT_HTTP_PORT:-9999}:8080"
    environment:
      - PLATFORM_PORT=8080
      - PLATFORM_MAX_MEM=${PRODUCT_MAX_MEM:-24g}
      - DATABASE_DRIVER_CLASS=org.mariadb.jdbc.Driver
      - DATABASE_URL=jdbc:mariadb://database:3306/aif?useMysqlMetadata=true
      - DATABASE_USERNAME=aif
      # kics-scan ignore-line
      - DATABASE_PASSWORD=getaccess
      - SOLR_HOSTNAME=solr
      - SOLR_PORT=8983
    depends_on:
      - database
      - solr
    volumes:
      - resourceVolPlatform-hd:/opt/resources/platform
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health-discovery"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 1m

  database:
    image: docker.io/library/mariadb:11.5.2@sha256:4a1de8fa2a929944373d7421105500ff6f889ce90dcb883fbb2fdb070e4d427e
    command: --max_allowed_packet=1g --innodb_buffer_pool_size=512m --innodb_log_buffer_size=256m --innodb_log_file_size=256m
    environment:
      # kics-scan ignore-line
      - MYSQL_ROOT_PASSWORD=getaccess
      - MYSQL_DATABASE=aif
      - MYSQL_USER=aif
      # kics-scan ignore-line
      - MYSQL_PASSWORD=getaccess

  solr:
    image: registry.averbis.com/solr/solr:9.4.0@sha256:8f06706c7846366b4eb2bd8eb0d521a3771f03e606588034b6a297a592069328
    environment:
      - SOLR_MAX_MEM=512m
      - TEXTANALYSIS_URL=http://${PLATFORM_HOSTNAME:-health-discovery-hd}:${PLATFORM_PORT:-8080}/health-discovery/rest
    volumes:
      - solrDataVol-hd:/opt/solr/server/solr/solrCores
      - solrTermsVol-hd:/opt/solr/server/solr/terms
      - solrLogVol-hd:/opt/solr/server/logs
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8983/solr/terms/admin/ping"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  kafka:
    image: docker.io/bitnami/kafka:3.8.0@sha256:bf8d03af193918f3d2dff806e02b1f236e31bc7aa36718e10dec7a8c42231511
    profiles:
      - kafka
    restart: unless-stopped
    cap_drop:
      - ALL
    privileged: false
    ipc: none
    security_opt:
      - "no-new-privileges:true"
    environment:
      KAFKA_CFG_NODE_ID: "0"
      KAFKA_RAFT_CLUSTER_ID: "diz-in-a-box"
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: "0@kafka:9093"
      KAFKA_CFG_PROCESS_ROLES: "controller,broker"
      ALLOW_PLAINTEXT_LISTENER: "yes"
      KAFKA_CFG_MESSAGE_MAX_BYTES: "31457280"
      KAFKA_CFG_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094"
      KAFKA_CFG_ADVERTISED_LISTENERS: "PLAINTEXT://kafka:9092,EXTERNAL://localhost:9094"
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
    ports:
      - 9094:9094

  akhq:
    image: tchiotludo/akhq:0.25.1@sha256:cfaef8f419c4e4b78c583597d6428b63166e90eeb194af890264d68051a22180
    profiles:
      - kafka
    environment:
      AKHQ_CONFIGURATION: |
        akhq:
          connections:
            kafka-compose:
              properties:
                bootstrap.servers: "kafka:9092"
    ports:
      - 8090:8080
    depends_on:
      - kafka

  kafka-data-loader:
    image: confluentinc/cp-kafkacat:7.1.14@sha256:85ef7339cc27b33660d48c6bc3fd7e63317fd359f7f6b1bdc10f091db486b061
    profiles:
      - kafka
    entrypoint: ["/bin/bash", "-c"]
    command:
      [
        "while true; do kafkacat -b kafka:9092 -t fhir.documents -P -p 0 /data/documentreference.json; sleep 10; done",
      ]
    volumes:
      - ./tests/resources/fhir:/data:ro
    depends_on:
      - kafka

volumes:
  resourceVolPlatform-hd:
    driver: "local"
  dbVol-hd:
    driver: "local"
  solrDataVol-hd:
    driver: "local"
  solrLogVol-hd:
    driver: "local"
  solrTermsVol-hd:
    driver: "local"
